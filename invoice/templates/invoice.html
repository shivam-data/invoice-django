{% extends 'base.html' %}
{% block listinvoices %}

 <div class="pageContent">

<table>
    <tr>
        <td>
            <div class="container-fluid">
                <div class="row">

                    <div class="col-md-6.5">
                        <div class="card">
                            <div class="card-body">

                                <div class="mb-5">
                                   <h4>Invoice Details</h4>
                                </div>
                                <form action="{% url 'create'%}" method="post">
                                    {%csrf_token%}
                                    <div class="row">
                                    <div class="col-md-8">
                                        <label for="exampleInputEmail1">Invoice No / Bill No</label>
                                        <div class="input-group mb-3">
<!--                                            <input type="text" class="form-control form-control-sm" placeholder="">-->
                                            {{form.invoice_no}}
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary btn-sm" type="button"
                                                    id="invoice_no" data-toggle="popover" data-trigger="focus" data-content="Tagging active">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <label for="exampleInputEmail1">Invoice Date</label>
                                        <div class="input-group mb-3">
<!--                                            <input type="text" class="form-control form-control-sm" placeholder="">-->
                                            {{form.invoice_date}}
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary btn-sm" type="button"
                                                    id="invoice_date" data-toggle="popover" data-trigger="focus" data-content="Tagging active">

                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    </div>

                                    <div>
                                        <label for="exampleInputEmail1">GSTIN</label>
                                        <div class="input-group mb-3">
<!--                                            <input type="text" class="form-control form-control-sm" placeholder="">-->
                                            {{form.gstin}}
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary btn-sm" type="button"
                                                    id="gstin" data-toggle="popover" data-trigger="focus" data-content="Tagging active">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div>
                                        <label for="exampleInputEmail1">Vendor Name</label>
                                        <div class="input-group mb-3">
<!--                                            <input type="text" class="form-control form-control-sm" placeholder="">-->
                                            {{form.vendor_name}}
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary btn-sm" type="button"
                                                    id="vendor_name" data-toggle="popover" data-trigger="focus" data-content="Tagging active">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">

                                    <div class="col-md-6">
                                        <label for="exampleInputEmail1">Email</label>
                                        <div class="input-group mb-3">
<!--                                            <input type="text" class="form-control form-control-sm" placeholder="">-->
                                            {{form.email}}
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary btn-sm" type="button"
                                                    id="email" data-toggle="popover" data-trigger="focus" data-content="Tagging active">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="exampleInputEmail1">Phone Number</label>
                                        <div class="input-group mb-3">
                                            {{form.phone_number}}
<!--                                            <input type="text" class="form-control form-control-sm" placeholder="">-->
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary btn-sm" type="button"
                                                    id="phone_number" data-toggle="popover" data-trigger="focus" data-content="Tagging active">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    </div>
                                    <div>
                                        <label for="exampleInputEmail1">IMEI</label>
                                        <div class="input-group mb-3">
<!--                                            <input type="text" class="form-control form-control-sm" placeholder="">-->
                                            {{form.imei}}
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary btn-sm" type="button"
                                                    id="imei" data-toggle="popover" data-trigger="focus" data-content="Tagging active">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="exampleInputEmail1">Vendor Address</label>
                                        <div class="input-group mb-3">
<!--                                            <input type="text" class="form-control form-control-sm" placeholder="">-->
                                            {{form.vendor_address}}
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary btn-sm" type="button"
                                                    id="vendor_address" data-toggle="popover" data-trigger="focus" data-content="Tagging active">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                      <table class="table table-borderless border mt-4">
                                    <thead>
                                      <tr>
                                        <th scope="col">Item</th>
                                        <th scope="col" class="text-right">Amount</th>
                                      </tr>
                                    </thead>
<!--                                {% for title in titles%}-->
<!--                                    {{title}}-->
<!--                                    {% endfor %}-->

                                    {% crispy form %}
                                </form>

                            </div>
                        </div>
                    </div>

                </div>

            </div>
</td>
        <td>
            <div class="col-40">
                        <div class="text-center">
                            <button id="prev" class="btn btn-primary">Previous</button>
                            <button id="next" class="btn btn-primary">Next</button>
                            &nbsp;<button id="clear" class="btn btn-primary">Clear</button>
                            <span>Page: <span id="page_num"></span> / <span id="page_count"></span></span>
                        </div>

                <div class="card pdf" id="pdf-card">
                    <div class="mask flex-center rgba-red-strong">
                        <canvas id="the-canvas" class="w-150"></canvas>
                    </div>
                </div>
                </div>




    </td>
    </tr>
    </table>

        </div>


    </div>

    <script type="text/javascript" src="{% static 'js/annotorious.min.js' %}"></script>

      <script>
          let global_tag_id ;

          function focus(tag_id) {
              document.getElementById('pdf-card').className = "card pdf shadow-lg";
              global_tag_id = tag_id
          }

          document.getElementById('invoice_no').addEventListener('click',function (){focus('invoice_no')})
          document.getElementById('invoice_date').addEventListener('click',function (){focus('invoice_date')})
          document.getElementById('vendor_address').addEventListener('click',function (){focus('vendor_address')})
          document.getElementById('vendor_name').addEventListener('click',function (){focus('vendor_name')})
          document.getElementById('imei').addEventListener('click',function (){focus('imei')})
          document.getElementById('gstin').addEventListener('click',function (){focus('gstin')})
          document.getElementById('email').addEventListener('click',function (){focus('email')})
          document.getElementById('phone_number').addEventListener('click',function (){focus('phone_number')})




    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script>
        $(function () {
    $('[data-toggle="popover"]').popover()
        })
    </script>
    <script>
        // If absolute URL from the remote server is provided, configure the CORS
        // header on that server.
        //var url = 'https://raw.githubusercontent.com/mozilla/pdf.js/ba2edeae/web/compressed.tracemonkey-pldi-09.pdf';
        var url = '{{ pdf_file }}'
        console.log(' {{pdf_file}} ')

        // Loaded via <script> tag, create shortcut to access PDF.js exports.
        var pdfjsLib = window['pdfjs-dist/build/pdf'];

        // The workerSrc property shall be specified.
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.5.207/pdf.worker.js';

        // Asynchronous download of PDF

        var pdfDoc = true,
            pageNum = 1,
            pageRendering = false,
            pageNumPending = null,
            scale = 1,
            canvas = document.getElementById('the-canvas'),
            ctx = canvas.getContext('2d')
        /**
         * Get page info from document, resize canvas accordingly, and render page.
         * @param num Page number.
         */

        function renderPage(num) {
            pageRendering = true;
            // Using promise to fetch the page
            pdfDoc.getPage(num).then(function (page) {
                var viewport = page.getViewport({ scale: scale });
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                // Render PDF page into canvas context
                var renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                anno = newannote()
                var renderTask = page.render(renderContext);

                // Wait for rendering to finish
                renderTask.promise.then(function () {
                    pageRendering = false;
                    if (pageNumPending !== null) {
                        // New page rendering is pending
                        renderPage(pageNumPending);
                        pageNumPending = null;

                    }

                });
            });

            // Update page counters
            document.getElementById('page_num').textContent = num;
            return anno
        }

        /**
         * If another page rendering in progress, waits until the rendering is
         * finised. Otherwise, executes rendering immediately.
         */
        function queueRenderPage(num) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                anno = renderPage(num);
                return anno
            }
        }

        /**
         * Displays previous page.
         */
        function onPrevPage() {
            if (pageNum <= 1) {
                return;
            }
            pageNum--;
            anno = queueRenderPage(pageNum);
            anno.destroy()
        }
        document.getElementById('prev').addEventListener('click', onPrevPage);

        /**
         * Displays next page.
         */
        function onNextPage() {
            if (pageNum >= pdfDoc.numPages) {
                return;
            }
            pageNum++;
            anno = queueRenderPage(pageNum);
            anno.destroy()
        }
        document.getElementById('next').addEventListener('click', onNextPage);

        function clearPage(anno){
            anno.destroy()
            renderPage(pageNum)
        }

        document.getElementById('clear').addEventListener('click',function (){clearPage(anno)})

        // function generate(){
        //     renderPage(1)
        // }
        //
        // document.getElementById('gen').addEventListener('click',generate)

        pdfjsLib.getDocument(url).promise.then(function (pdfDoc_) {
            pdfDoc = pdfDoc_;

            document.getElementById('page_count').textContent = pdfDoc.numPages;

            // Initial/first page rendering
            renderPage(pageNum);
        });

        function call(global_id_tag,vals) {
            if(global_id_tag){
       $.ajax({
           type: "POST",
           url: "test",
           data: { csrfmiddlewaretoken: '{{ csrf_token }}',
            vals:vals,global_id_tag:global_id_tag,pageNum:pageNum,
           height:canvas.height,width:canvas.width},
           success: function () {
                console.log('success')
           }
       })
            }
            else {
                anno.destroy()
                renderPage(pageNum)
                alert('No Label selected')
                return
            }
        }

        function newannote() {
        var anno = Annotorious.init({
          image: 'the-canvas',
          locale: 'auto',
        });

        anno.on('selectAnnotation', function(annotation) {
          console.log('selected', annotation);
        });

        anno.on('createAnnotation', function(a) {
            var vals = a.target.selector.value
            console.log('created', vals);
            console.log(vals)
            console.log(global_tag_id)
            call(global_tag_id,vals)
        });

        anno.on('updateAnnotation', function(annotation, previous) {
          console.log('updated', previous, 'with', annotation);
        });

        anno.on('deleteAnnotation', function(annotation) {
          console.log('deleted', annotation);
        });

        anno.loadAnnotations("{% static 'js/annotorious.w3c.json' %}");

        return anno
      }


    </script>

{% endblock %}