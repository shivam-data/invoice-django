{% extends 'base.html' %}
{% block listinvoices %}
{% load static %}
<div class="container-fluid">
                <div class="row" id="first-row">

                    <div class="col-md-6" id="invoice-card">
                        <div class="card">
                            <div class="card-body">

                                <div class="mb-5">
                                    <h4>Invoice Details</h4>
                                </div>
                                <form action="{% url 'create' %}" method="post" id="invoice-form">
                                    {% csrf_token %}
                                    <div class="row">
                                    <div class="col-md-8">
                                        <label for="exampleInputEmail1">Invoice No / Bill No</label>
                                        <div class="input-group mb-3">
<!--                                            <input type="text" class="form-control form-control-sm" placeholder="">-->
                                            {{ form.invoice_no }}
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary btn-sm" type="button"
                                                    id="invoice_no" data-toggle="popover" data-trigger="focus" data-content="Tagging active">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <label for="exampleInputEmail1">Invoice Date</label>
                                        <div class="input-group mb-3">
<!--                                            <input type="text" class="form-control form-control-sm" placeholder="">-->
                                            {{ form.invoice_date }}
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary btn-sm" type="button"
                                                    id="invoice_date" data-toggle="popover" data-trigger="focus" data-content="Tagging active">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    </div>

                                    <div>
                                        <label for="exampleInputEmail1">GSTIN</label>
                                        <div class="input-group mb-3">
<!--                                            <input type="text" class="form-control form-control-sm" placeholder="">-->
                                            {{ form.gstin }}
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary btn-sm" type="button"
                                                    id="gstin" data-toggle="popover" data-trigger="focus" data-content="Tagging active">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div>
                                        <label for="exampleInputEmail1">Vendor Name</label>
                                        <div class="input-group mb-3">
<!--                                            <input type="text" class="form-control form-control-sm" placeholder="">-->
                                            {{ form.vendor_name }}
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary btn-sm" type="button"
                                                    id="vendor_name" data-toggle="popover" data-trigger="focus" data-content="Tagging active">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">

                                    <div class="col-md-6">
                                        <label for="exampleInputEmail1">Email</label>
                                        <div class="input-group mb-3">
<!--                                            <input type="text" class="form-control form-control-sm" placeholder="">-->
                                            {{ form.email }}
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary btn-sm" type="button"
                                                    id="email" data-toggle="popover" data-trigger="focus" data-content="Tagging active">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="exampleInputEmail1">Phone Number</label>
                                        <div class="input-group mb-3">
<!--                                            <input type="text" class="form-control form-control-sm" placeholder="">-->
                                            {{ form.phone_number }}
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary btn-sm" type="button"
                                                    id="phone_number" data-toggle="popover" data-trigger="focus" data-content="Tagging active">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    </div>
                                    <div>
                                        <label for="exampleInputEmail1">IMEI</label>
                                        <div class="input-group mb-3">
<!--                                            <input type="text" class="form-control form-control-sm" placeholder="">-->
                                            {{ form.imei }}
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary btn-sm" type="button"
                                                    id="imei" data-toggle="popover" data-trigger="focus" data-content="Tagging active">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="exampleInputEmail1">Vendor Address</label>
                                        <div class="input-group mb-3">
<!--                                            <input type="text" class="form-control form-control-sm" placeholder="">-->
                                            {{ form.vendor_address }}
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary btn-sm" type="button"
                                                    id="vendor_address" data-toggle="popover" data-trigger="focus" data-content="Tagging active">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                             <table class="table table-hover" id="item-table">
                                <thead>
                                <tr>
                                    <td>item name</td>
                                    <td>item quantity</td>
                                    <td>item rate</td>
                                </tr>
                                </thead>
                            </table>

                                    <button id="a-href" class="btn btn-link">Add new item</button><br>
                                    <br>
                                    <br>
                                     <button class="btn btn-primary" type="submit">Save</button>
                                    <button class="btn btn-primary" id="send">Send</button>
                                  <button class="btn btn-light" type="reset">Cancel</button>
                                </form>

                            </div>
                        </div>
                    </div>

                    <div class="col-md-6" id="invoice2-card" style="display: none">
                        <div class="card" >
                            <div class="card-body">

                                <div class="mb-5">
                                    <h4>Item Details</h4>
                                </div>
                                    <div class="row">
                                    <div class="col-md-8">
                                        <label for="exampleInputEmail1">Item Name</label>
                                        <div class="input-group mb-3">
                                            <input type="text" class="form-control form-control-sm" placeholder="" required id="item_name_input" value="">

                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary btn-sm" type="button"
                                                    id="item_name" data-toggle="popover" data-trigger="focus" data-content="Tagging active" value="">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <label for="exampleInputEmail1">Item Quantity</label>
                                        <div class="input-group mb-3">
                                            <input type="text" class="form-control form-control-sm" placeholder="" required id="item_name_quantity" value="">

                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary btn-sm" type="button"
                                                    id="item_q" data-toggle="popover" data-trigger="focus" data-content="Tagging active">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    </div>

                                    <div>
                                        <label for="exampleInputEmail1">Item Rate</label>
                                        <div class="input-group mb-3">
                                            <input type="text" class="form-control form-control-sm" placeholder="" required id="item_name_rate">
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary btn-sm" type="button"
                                                    id="item_r" data-toggle="popover" data-trigger="focus" data-content="Tagging active">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                     <button class="btn btn-primary" type="submit" id="submit-of-items">Add</button>
                                  <button class="btn btn-light" type="reset" id="clear-of-items">Cancel</button>


                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="text-center">
                            <button id="prev" class="btn btn-primary">Previous</button>
                            <button id="next" class="btn btn-primary">Next</button>
                            <button id="clear" class="btn btn-primary">Clear</button>&nbsp;
                            <span>Page: <span id="page_num"></span> / <span id="page_count"></span></span>
                        </div>
                    <div class="card pdf" id="pdf-card">
                        <div class="mask flex-center rgba-red-strong">
                            <canvas id="the-canvas" class="w-150"></canvas>
                        </div>
                    </div>
                    </div>


        </div>

<script type="text/javascript" src="{% static 'js/annotorious.min.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
$(function () {
  $('[data-toggle="popover"]').popover()
})
</script>

<script>

    function addrow(name,quantity,rate){
        var table = document.getElementById('item-table');
        var row = table.insertRow();

        var cell1 = row.insertCell(0)
        var cell2 = row.insertCell(1)
        var cell3 = row.insertCell(2)

        cell1.innerText = name;
        cell2.innerText = quantity;
        cell3.innerText = rate;
    }

    // hiding script
$('#a-href').click(function () {
    $('#invoice-card').toggle()
    $('#invoice2-card').toggle()
})
 $('#clear-of-items').click(function () {
     $('#invoice-card').toggle()
     $('#invoice2-card').toggle()
 })

$('#submit-of-items').click(function () {
    $('#invoice-card').toggle()
    $('#invoice2-card').toggle()
    console.log('in the ajax')
    item_d = $('#item_name_input').val()
    item_r = $('#item_name_rate').val()
    item_q = $('#item_name_quantity').val()

    item_values.push({
    item_d :item_d,
    item_r :item_r,
    item_q:item_q
    })
    addrow(item_d,item_r,item_q)
})
    // $.ajax({
    //        type: "POST",
    //        url: "additem",
    //        data: {
    //            csrfmiddlewaretoken: '{{ csrf_token }}',
    //            item_d: item_d,
    //            item_r: item_r,
    //            item_q: item_q
    //        },
    //        success: function () {
    //             console.log('success')
    //            // location.href = 'create'
    //            addrow(item_d,item_r,item_q)
    //            console.log(item_d,item_r,item_q)
    //        }
    //    })
    // })

</script>

<script>
// script for rendering pdf
    // also adds the annotator.js
    var url = '{{ pdf_file }}'
    console.log(' {{pdf_file}} ')
        // Loaded via <script> tag, create shortcut to access PDF.js exports.
        var pdfjsLib = window['pdfjs-dist/build/pdf'];

        // The workerSrc property shall be specified.
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.5.207/pdf.worker.js';

        // Asynchronous download of PDF

        var pdfDoc = true,
            pageNum = 1,
            pageRendering = false,
            pageNumPending = null,
            scale = 1,
            canvas = document.getElementById('the-canvas'),
            ctx = canvas.getContext('2d'),
            values = [],
            dict = {},
            item_values = []
        /**
         * Get page info from document, resize canvas accordingly, and render page.
         * @param num Page number.
         */
        console.log(values)
        function renderPage(num) {
            pageRendering = true;
            // Using promise to fetch the page
            pdfDoc.getPage(num).then(function (page) {
                var viewport = page.getViewport({ scale: scale });
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                // Render PDF page into canvas context
                var renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                anno = newannote()
                var renderTask = page.render(renderContext);

                // Wait for rendering to finish
                renderTask.promise.then(function () {
                    pageRendering = false;
                    if (pageNumPending !== null) {
                        // New page rendering is pending
                        renderPage(pageNumPending);
                        pageNumPending = null;

                    }

                });
            });

            // Update page counters
            document.getElementById('page_num').textContent = num;
            return anno
        }

        /**
         * If another page rendering in progress, waits until the rendering is
         * finised. Otherwise, executes rendering immediately.
         */
        function queueRenderPage(num) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                anno = renderPage(num);
                return anno
            }
        }

        /**
         * Displays previous page.
         */
        function onPrevPage() {
            if (pageNum <= 1) {
                return;
            }
            pageNum--;
            anno = queueRenderPage(pageNum);
            anno.destroy()
        }
        document.getElementById('prev').addEventListener('click', onPrevPage);

        /**
         * Displays next page.
         */
        function onNextPage() {
            if (pageNum >= pdfDoc.numPages) {
                return;
            }
            pageNum++;
            anno = queueRenderPage(pageNum);
            anno.destroy()
        }
        document.getElementById('next').addEventListener('click', onNextPage);

        function clearPage(anno){
            anno.destroy()
            renderPage(pageNum)
        }

        document.getElementById('clear').addEventListener('click',function (){clearPage(anno)})

        pdfjsLib.getDocument(url).promise.then(function (pdfDoc_) {
            pdfDoc = pdfDoc_;

            document.getElementById('page_count').textContent = pdfDoc.numPages;

            // Initial/first page rendering
            renderPage(pageNum);
        });

        function call(global_id_tag,vals) {
            if(global_id_tag){
                dict['vals'] = vals
                dict['global_tag_id'] = global_id_tag
                values.push(dict)
                console.log('values: ',values)

            }
            else {
                anno.destroy()
                renderPage(pageNum)
                alert('No Label selected')
                return
            }
        }

        function newannote() {
        var anno = Annotorious.init({
          image: 'the-canvas',
          locale: 'auto',
        });

        anno.on('selectAnnotation', function(annotation) {
          console.log('selected', annotation);
        });

        anno.on('createAnnotation', function(a) {
            var vals = a.target.selector.value
            console.log('created', vals);
            console.log(vals)
            console.log(global_tag_id)
            call(global_tag_id,vals)
        });

        anno.on('updateAnnotation', function(annotation, previous) {
          console.log('updated', previous, 'with', annotation);
        });

        anno.on('deleteAnnotation', function(annotation) {
          console.log('deleted', annotation);
        });


        return anno
      }

       var frm = $('#invoice-form');
        frm.submit(function () {
        console.log('in the action form')
        $.ajax({
            type: 'post',
            url: 'test',
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                invoice_id: $('#invoice_no'),
                annotation_values: values,
                item_values: item_values
            },
            success: function (data) {
                console.log('success action');
            },
            error: function(data) {
               console.log('error action')
            }
        });
    });
        $('#send').click(function () {
          $.ajax({
            type: 'post',
            url: 'test',
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                invoice_id: $('#invoice_no'),
                annotation_values: values,
                item_values: item_values
            },
            success: function (data) {
                console.log('success action');
            },
            error: function(data) {
               console.log('error action')
            }
        });
        })


</script>

<script>
    // item form post request

</script>
<script>
            // script for extracting the tag

          let global_tag_id ;

          function focus(tag_id) {
              document.getElementById('pdf-card').className = "card pdf shadow-lg blue";
              global_tag_id = tag_id
          }

          document.getElementById('invoice_no').addEventListener('click',function (){focus('invoice_no')})
          document.getElementById('invoice_date').addEventListener('click',function (){focus('invoice_date')})
          document.getElementById('vendor_address').addEventListener('click',function (){focus('vendor_address')})
          document.getElementById('vendor_name').addEventListener('click',function (){focus('vendor_name')})
          document.getElementById('imei').addEventListener('click',function (){focus('imei')})
          document.getElementById('gstin').addEventListener('click',function (){focus('gstin')})
          document.getElementById('email').addEventListener('click',function (){focus('email')})
          document.getElementById('phone_number').addEventListener('click',function (){focus('phone_number')})
</script>


{% endblock %}